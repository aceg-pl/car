<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>EU Auto Competitor Model Matrix</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg:#0f1115; --fg:#e8eaed; --muted:#9aa0a6; --line:#2a2f3a;
    --site-header-h: 66px;
  }

  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}

  header{position:sticky;top:0;background:#0f1115;z-index:30;border-bottom:1px solid var(--line)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;align-items:center}
  h1{font-size:18px;margin:0 0 8px 0;font-weight:600;flex:1 1 auto}

  .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
  label{color:var(--muted)}
  select,button{background:#151924;color:var(--fg);border:1px solid var(--line);padding:8px 10px;border-radius:8px;cursor:pointer}
  button:hover{border-color:#3a4252}

  .grid{
    overflow:auto;
    max-height:70vh;
    border:1px solid var(--line);
    border-radius:10px;
    background:#0f1115;
    position:relative;
    -webkit-overflow-scrolling: touch;
  }
  
  table{width:100%;border-collapse:separate;border-spacing:0;margin:0}
  th,td{border-bottom:1px solid var(--line);padding:8px 10px;vertical-align:middle;background:#0f1115}
  tbody tr:hover td{background:#131824}

  thead th{
    position:sticky;
    top: 0;
    z-index: 20;
    background:#0f1115;
    box-shadow: 0 1px 0 0 #2a2f3a;
  }

  #matrixTable th:first-child,
  #matrixTable td:first-child{
    position:sticky;
    left:0;
    z-index: 10;
    background:#0f1115;
    box-shadow: 1px 0 0 #2a2f3a;
    white-space:nowrap;
  }
  #matrixTable thead th:first-child{ z-index: 25 }

  .seg{white-space:nowrap;color:#cbd1d9;font-weight:600}
  .brandcell{display:flex;align-items:center;gap:8px;white-space:nowrap}
  .brandname{color:#cbd1d9;text-decoration:none}
  .brandname:hover{text-decoration:underline}
  .tag{font-size:11px;padding:2px 6px;border:1px solid var(--line);border-radius:6px;background:#121725;color:#9aa0a6;margin-left:6px}
  .model{color:var(--fg)}
  .blank{color:#9aa0a6}
  .note{font-size:12px;color:#9aa0a6;margin-top:8px}
  .icon{width:18px;height:18px;display:inline-block;vertical-align:middle;filter: invert(90%) sepia(5%) saturate(200%) hue-rotate(180deg) brightness(95%) contrast(90%)}

  .group-row td{
    background:#1e2536;
    color:#ff4d4d;
    font-weight:600;
    border-bottom:1px solid var(--line);
  }
  .group-row td:first-child{
    position:sticky;
    left:0;
    z-index:16;
    box-shadow:1px 0 0 #2a2f3a;
    white-space:nowrap;
    background:#1e2536;
    padding: 8px 6px; 
  }
  
  .group-meta{display:none}
  .group-toggle{
    cursor:pointer;
    user-select:none;
    margin-right:4px;
    display:inline-block;
    width:1.1em;
    text-align:center;
    border:1px solid var(--line);
    border-radius:4px;
    background:#121725;
    color:#9aa0a6;
    line-height:1em;
    padding:2px;
  }
  .group-toggle:focus{outline:2px solid #3a6df0;outline-offset:2px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1>EU Auto Competitor Model Matrix</h1>
      <div class="controls">
        <label for="viewSelect">View:</label>
        <select id="viewSelect" aria-label="View selector">
          <option value="all">All models</option>
          <option value="seg0">Compact Hatch/Sedan</option>
          <option value="seg1">Mid-Size Sedan</option>
          <option value="seg2">Executive Sedan</option>
          <option value="seg3">Compact SUV</option>
          <option value="seg4">Mid-Size SUV</option>
          <option value="seg5">Large / 3-Row</option>
        </select>
      </div>
      <div class="controls">
        <button id="downloadCsvBtn" type="button">Export CSV</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid" id="grid">
    <table id="matrixTable" aria-describedby="matrixNote">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
(function(){
  function setHeaderOffset(){
    const hdr = document.querySelector('header');
    const h = hdr ? Math.round(hdr.getBoundingClientRect().height) : 66;
    document.documentElement.style.setProperty('--site-header-h', h + 'px');
  }

  const ICON_CDN = 'https://cdn.jsdelivr.net/npm/simple-icons@latest/icons/';
  const ICON_SLUG = {
    "Audi":"audi","BMW":"bmw","Mercedes":"mercedes","Tesla":"tesla","Volvo":"volvo",
    "Lexus":"lexus","Genesis":"genesis","Porsche":"porsche","Jaguar":"jaguar","Land Rover":"landrover",
    "Alfa Romeo":"alfaromeo","Polestar":"polestar","Nio":"nio","BYD":"byd","Lucid":"lucid",
    "Volkswagen":"volkswagen","Škoda":"skoda","Cupra":"cupra","Peugeot":"peugeot","Citroën":"citroen",
    "Hyundai":"hyundai","Kia":"kia","Mazda":"mazda",
    "Ford":"ford","Honda":"honda","Toyota":"toyota","Renault":"renault","Opel":"opel","Vauxhall":"vauxhall",
    "Dacia":"dacia","SEAT":"seat","Nissan":"nissan","Suzuki":"suzuki","Mitsubishi":"mitsubishi","Subaru":"subaru",
    "DS":"dsautomobiles","Jeep":"jeep","Fiat":"fiat","MG":"mg"
  };

  // ✅ Official Polish brand websites
  const BRAND_PL_URL = {
    "Audi":"https://www.audi.pl/",
    "BMW":"https://www.bmw.pl/",
    "Mercedes":"https://www.mercedes-benz.pl/",
    "Tesla":"https://www.tesla.com/pl_pl/",
    "Volvo":"https://www.volvocars.com/pl/",
    "Lexus":"https://www.lexus-polska.pl/",
    "Genesis":"https://www.genesis.com/pl/",
    "Porsche":"https://www.porsche.pl/",
    "Jaguar":"https://www.jaguar.pl/",
    "Land Rover":"https://www.landrover.pl/",
    "Alfa Romeo":"https://www.alfaromeo.pl/",
    "Polestar":"https://www.polestar.com/pl/",
    "Nio":"https://www.nio.com/",
    "BYD":"https://bydauto.pl/",
    "Lucid":"https://lucidmotors.com/",
    "Volkswagen":"https://www.volkswagen.pl/",
    "Škoda":"https://www.skoda.pl/",
    "Cupra":"https://www.cupraofficial.pl/",
    "Peugeot":"https://www.peugeot.pl/",
    "Citroën":"https://www.citroen.pl/",
    "Hyundai":"https://www.hyundai.pl/",
    "Kia":"https://www.kia.com/pl/",
    "Mazda":"https://www.mazda.pl/",
    "Ford":"https://www.ford.pl/",
    "Honda":"https://www.honda.pl/",
    "Toyota":"https://www.toyota.pl/",
    "Renault":"https://www.renault.pl/",
    "Opel":"https://www.opel.pl/",
    "Vauxhall":"https://www.opel.pl/",
    "Dacia":"https://www.dacia.pl/",
    "SEAT":"https://www.seat.pl/",
    "Nissan":"https://www.nissan.pl/",
    "Suzuki":"https://auto.suzuki.pl/",
    "Mitsubishi":"https://www.mitsubishi.pl/",
    "Subaru":"https://www.subaru.pl/",
    "DS":"https://www.dsautomobiles.pl/",
    "Jeep":"https://www.jeep.pl/",
    "Fiat":"https://www.fiat.pl/",
    "MG":"https://mgmotor.pl/"
  };

  const SEGMENTS = ["Compact Hatch/Sedan","Mid-Size Sedan","Executive Sedan","Compact SUV","Mid-Size SUV","Large / 3-Row"];

  // (DATA + GROUPS unchanged for brevity, keep your original)
  const DATA = { /* ... your same model data ... */ };
  const GROUPS = { /* ... your same group mapping ... */ };

  const viewSelect = document.getElementById('viewSelect');
  const thead = document.querySelector('#matrixTable thead');
  const tbody = document.querySelector('#matrixTable tbody');

  function baseBrands(){
    const set = new Set();
    Object.keys(DATA).forEach(k => set.add(k.replace(/\s*\(.*\)$/, '')));
    return Array.from(set).sort((a,b)=> a.localeCompare(b,'en',{sensitivity:'base'}));
  }
  function brandRows(base){
    const keys = Object.keys(DATA).filter(k => k === base || k.startsWith(base + ' '));
    const order = k => k.includes('(Alt)') ? 1 : k.includes('(Addl)') ? 2 : 0;
    return keys.sort((a,b)=> order(a)-order(b));
  }
  function iconURL(base){
    const slug = ICON_SLUG[base];
    return slug ? ICON_CDN + slug + '.svg' : null;
  }
  function getView(){
    const v = viewSelect.value;
    if (v === 'all') return { all:true, seg:-1 };
    const idx = Number(v.replace('seg',''));
    return { all:false, seg:(Number.isFinite(idx)&&idx>=0&&idx<6)?idx:0 };
  }
  function groupKeyFor(base){ return GROUPS[base] || 'Other'; }
  function groupedBases(){
    const bases = baseBrands();
    const byGroup = {};
    bases.forEach(b=>{
      const g = groupKeyFor(b);
      (byGroup[g] ||= []).push(b);
    });
    const groupNames = Object.keys(byGroup).sort((a,b)=> a.localeCompare(b,'en',{sensitivity:'base'}));
    return { groupNames, byGroup };
  }

  const collapsed = new Map();

  function renderHeader(){
    thead.innerHTML = '';
    const tr = document.createElement('tr');
    const thBrand = document.createElement('th');
    thBrand.textContent = 'Brand';
    tr.appendChild(thBrand);
    const {all, seg} = getView();
    if (all){
      SEGMENTS.forEach(name=>{
        const th=document.createElement('th');
        th.innerHTML=`<div class="seg">${name}</div>`;
        tr.appendChild(th);
      });
    } else {
      const th=document.createElement('th');
      th.innerHTML=`<div class="seg">${SEGMENTS[seg]}</div>`;
      tr.appendChild(th);
    }
    thead.appendChild(tr);
  }

  function renderBody(){
    tbody.innerHTML='';
    const {all, seg}=getView();
    const {groupNames,byGroup}=groupedBases();

    groupNames.forEach(groupName=>{
      const trG=document.createElement('tr');
      trG.className='group-row';
      const tdG=document.createElement('td');
      const toggle=document.createElement('button');
      toggle.type='button';
      toggle.className='group-toggle';
      toggle.textContent=collapsed.get(groupName)?'+':'–';
      const label=document.createElement('span');
      label.textContent=groupName;
      tdG.appendChild(toggle);
      tdG.appendChild(label);
      trG.appendChild(tdG);
      const colCount=all?6:1;
      for(let i=0;i<colCount;i++){trG.appendChild(document.createElement('td'));}
      tbody.appendChild(trG);

      byGroup[groupName].forEach(base=>{
        brandRows(base).forEach(key=>{
          const tr=document.createElement('tr');
          tr.dataset.inGroup=groupName;
          if(collapsed.get(groupName))tr.style.display='none';

          const tdBrand=document.createElement('td');
          const url=iconURL(base);
          const img=url?`<img class="icon" alt="${base}" src="${url}" onerror="this.style.display='none'">`:'';
          const href=BRAND_PL_URL[base];
          const brandEl=href?`<a class="brandname" href="${href}" target="_blank" rel="noopener">${base}</a>`:`<span class="brandname">${base}</span>`;
          tdBrand.innerHTML=`<div class="brandcell">${img}${brandEl}${key!==base?`<span class="tag">${key.replace(base,'').trim()}</span>`:''}</div>`;
          tr.appendChild(tdBrand);

          const models=DATA[key]||[];
          if(all){
            for(let i=0;i<6;i++){
              const td=document.createElement('td');
              const v=models[i]||'(Blank)';
              td.innerHTML=v==='(Blank)'?`<span class="blank">(Blank)</span>`:`<span class="model">${v}</span>`;
              tr.appendChild(td);
            }
          } else {
            const td=document.createElement('td');
            const v=models[seg]||'(Blank)';
            td.innerHTML=v==='(Blank)'?`<span class="blank">(Blank)</span>`:`<span class="model">${v}</span>`;
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        });
      });

      toggle.addEventListener('click',()=>{
        const isCollapsed=collapsed.get(groupName)===true;
        const nextState=!isCollapsed;
        collapsed.set(groupName,nextState);
        toggle.textContent=nextState?'+':'–';
        let n=trG.nextElementSibling;
        while(n && !n.classList.contains('group-row')){
          n.style.display=nextState?'none':'';
          n=n.nextElementSibling;
        }
      });
    });
  }

  function exportCSV(){
    const rows=[];
    const {all,seg}=getView();
    if(all)rows.push(['Brand Group','Brand',...SEGMENTS]);
    else rows.push(['Brand Group','Brand',SEGMENTS[seg]]);
    const {groupNames,byGroup}=groupedBases();
    groupNames.forEach(g=>{
      byGroup[g].forEach(b=>{
        brandRows(b).forEach(k=>{
          const models=DATA[k]||[];
          const brandLabel=b+(k!==b?` ${k.replace(b,'')}`:'');
          if(all)rows.push([g,brandLabel,...models.map(x=>x||'(Blank)')]);
          else rows.push([g,brandLabel,models[seg]||'(Blank)']);
        });
      });
    });
    const csv=rows.map(r=>r.map(s=>{
      const t=String(s);return /[",\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t;
    }).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=all?'EU_Auto_Competitor_Model_Matrix_all.csv':`EU_Auto_Competitor_Model_Matrix_${SEGMENTS[seg].replace(/\s+/g,'_')}.csv`;
    document.body.appendChild(a);a.click();a.remove();
  }

  function start(){
    setHeaderOffset();
    renderHeader();renderBody();
    window.addEventListener('resize',setHeaderOffset,{passive:true});
    viewSelect.addEventListener('change',()=>{renderHeader();renderBody();});
    document.getElementById('downloadCsvBtn').addEventListener('click',exportCSV);
  }

  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',start);
  else start();
})();
</script>
</body>
</html>
